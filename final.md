小组成员：



#### 数据库

##### MySQL:zyk, wrh

在前期经过调研之后，我们决定使用`MySQL` 。

**[这里需要吹一波MySQL]** (zyx)

**PEEWEE:zyk, wrh**

使用Python ORM Peewee来操作数据库

**[这里需要吹一波ORM和Peewee]** (zyx)

接下来对数据库中各个TABLE逐一进行说明。

**[这里吹一波peewee]**(wrh)

##### user

##### post

##### post_file

##### reply

##### collects

##### likes



#### 功能部分

本次后端主要使用`python` ，以`flask`作为Web应用框架。实现了社交网络的基本功能。

**[这里需要吹一波Flask]**  (zyx)

接下来对本网站实现的功能进行详细说明。



##### 用户管理

###### 注册:zyk ,xqm

注册步骤

1. 点击首页左上角的注册按钮进入注册界面。

1. 依次填写用户名、昵称、邮箱、密码、验证码。其中密码需要连续输入两次进行确认。
2. 若填写均无误，点击提交，即可注册完毕。

实现说明：

[前端接口说明]

后端利用`get_register_info()`函数，从`request`中解析出用户输入的`username`，`password`，`nickname`，`email`，`imagecode`。如果一切都是合法的，那么在数据库中的user表总插入对应表项，并自动转到登录界面。其中若未输入昵称，则默认昵称就是用户名。

若不合法，则回到注册界面并显示响应错误提示。可能出现的错误有：

1. 未输入用户名、密码、电子邮件

2. 用户名和已经注册用户重名

3. 两次输入的密码不匹配

4. 验证码错误

5. 用户名或昵称过长(超过40个字符)

这里不直接存取`password` ，而是使用`werkzeug.security`中的`generate_password_hash`函数，计算出`password`的哈希值，最后将该哈希值存储在数据库中。如此就算数据库中的数据出现泄漏，也可以保障用户的密码信息这个关键信息不被泄漏。



###### 登录:  zyk ,xqm

[前端说明]

登录步骤

1. 点击首页左上角的登录按钮进入登录界面，注册完毕之后也会自动跳转到登录界面
2. 输入用户名，密码，验证码
3. 若用户名已被注册且密码正确，则进入主界面，同时在主界面中显示

如果在数据库中没有找到匹配的用户名，则回到登录界面并显示“用户名不存在”。

如果输入的验证码错误，回到登录界面并显示“验证码错误”。

由于在数据库中存储的是注册时使用密码的哈希值，因此登录时检查密码是否匹配的过程具体如下：利用同样的哈希函数为输入的密码生成哈希值，若此哈希值和数据库中存储的哈希值相同，则认为输入的密码是正确的。否则，回到登录界面并显示“密码不正确”。



###### 验证码: wrh

[前端]

后端生成、验准验证码。

`valid_picture()`函数生成五个字符的验证码，拥有大小、位置、形状的改变，有干扰线和模糊滤镜。

`get_code()`函数将验证码图片以二进制形式写入在内存中，防止将图片都放在文件夹中、占用磁盘空间。把这个二进制形式的验证码作为response返回给前端，并在`session['imagecode']`中记录验证码对应的字符串。

如果验证码图片看不清，点击验证码即可刷新，因为点击一次验证码图片即调用一次`get_code()`函数。

在注册和登陆时，验准用户输入的验证码和`session['imagecode']`中记录验证码字符串是否相同。





###### 个人主页:wrh, xqm

[前端说明]

后端利用`get_home_info()`函数，分别在`user table`、`posts table`和`collects table`中获取用户信息、用户发过的贴子和用户收藏的贴子。



###### 个人设置:wrh, xqm

[前端说明]

后端利用`set_name()`、`set_mail()`和`set_pass()`三个函数，分别通过向数据库写入的方式，更改用户昵称、邮箱和密码。



##### 贴子管理

###### 主界面：wrh, xqm(包括精品贴子的实现)

[前端]

从`post table`中获取贴子、点赞数、回复数、收藏数、是否置顶等信息。

从`user table`中获取对应贴子的作者信息。

从`post_file table`中获取对应贴子的附件情况。

从`post table`中以`hot`字段（由计算热度的线程定时计算）降序获取热贴。



###### 热贴：wrh，xqm

[前端]

热贴计算使用`Hacker News`的方法：
$$
Score = \frac{numreply + numview + 1}{(delta+2)^{1.8}}
$$
其中，numreply是回复数，numview是发贴数，delta是发贴到现在的时间，以小时为单位。

为了实时计算热贴，需要新开一个线程，隔一段时间唤醒一次，更新数据库中每个贴子的`Score`。具体实现请参见`start_calc.py`和`hot_calculator.py`两个程序，分别是线程管理程序和热度计算程序。



###### 发贴:wrh,xqm

[前端]

发贴时，先确认前端输入了`title`。

之后向`post table`写入`title`、`body`、`author_id`等信息，默认不加精、不置顶，点赞数、收藏数、访问量初始值为0。

如果上传了文件，在`post_file table`中写入文件。



###### 文件:zyk, xqm

- 上传步骤：用户在发帖时，若想上传文件，可以点击发表新帖页面中的选择文件，选择想要上传的本地文件。本次仅允许用户上传一个文件，多个文件可以通过将其压缩的方式方式上传。
- 下载步骤：用户想要下载某文件，可以在帖子展示界面点击显示有文件的按钮，如果文件安全，用户就可以选择希望文件下载到的用户电脑上的地址，之后就可以开始文件传输。

我们并不在数据库中存取文件的全部内容，而是只是在数据库中维护文件的文件名和一个哈希值，而将文件存在服务器本地一个文件夹。这样做是考虑到文件的大小可能会有很大的差异，如果在数据库里维护添加一列来存放文件内容，不同文件的这一信息就会有很大差异，很难管理。同时一旦有一个很大的文件，就会导致整个数据库的内容迅速变大，使得在数据库上的操作变得极其缓慢。

为了解决存在服务器本地的文件安全性问题，我们选择在数据库中存取文件的一个hash值，以此记录文件最开始的信息。之后用户需要下载文件的时候，我们通过这个哈希值检查此时存在服务器本地的文件是否和最初存入时内容相同。一旦内容被改动过，我们就拒绝用户下载这个文件，表明这个文件可能已经不再安全。

基于此，**[前端内容]**

用户想要上传文件时，可以将本地文件的文件内容和文件名等信息通过POST的方式传给服务器后端，然后我们通过哈希函数记录此时文件内容的哈希值，将该哈希值和文件名一起存入数据库的`post_file`表格中。

下载时，后端利用数据库中的信息检查文件是否被改动，一旦被改动，则返回显示帖子的界面，并显示错误信息“文件已被改动”来暗示用户这个文件已经不再安全，不能下载这个文件。

###### 回复:wrh,xqm

[前端]

添加回复时，从前端`body`、`author_id`、`post_id`添加进`reply table`。

删除回复时，从`reply table`中删除`reply_id`匹配的内容。

注意添加或删除回复的同时，要更新`post table`里对应贴子的`num_reply`字段。



##### 搜索功能：wrh, xqm

[前端说明]

使用`like()`语句进行匹配。

要搜索关键词是ST，就在`like()`中的关键词前后要加通配符`%`。

具体可见`title_search()`函数和`user_search()`函数。



##### 管理员界面：zyk, zyx

如果检测到登录者是管理员，则在主界面会多一个按钮：`管理界面` 。管理员可以通过此按钮进入管理员首页。本地代码默认管理员只有一个，且最先注册的人就是管理员。在管理界面的左上方有5个按钮，通过这些按钮分别可以进入对应的首页和管理界面。

###### 用户管理

管理步骤：

1. 在管理员首页点击`用户管理`按钮可以进入用户管理界面。
2. 在用户管理界面可以显示所有用户的信息，
3. 若想搜索对应用户的信息，可以在搜索框输入目标用户的用户名或者昵称的信息，点击搜索用户，即可显示对应用户的相关信息。关键词没有必要是完全匹配，可以是部分匹配。
4. 点击`禁言`、`删除用户`按钮即可完成对相应用户禁言的功能。用户一旦被禁言，在对应的界面中，`发表新帖`和`回复`按钮就会消失，如此该用户就无法发帖、无法回复。

想要禁言或删除用户时，前端将用户相关信息发送给后端；后端接收到接收到前端发来的相关信息，根据这个信息修改数据库中对应表项即可完成修改。

删除用户时，首先找到和这个用户相关的所有帖子和回复，先将它们全部删除，之后在把数据库中对应表项删除。

###### 帖子管理

管理步骤：

1. 在管理员首页点击`帖子管理`按钮可以进入帖子管理界面。
2. 在帖子管理界面可以显示所有帖子的发帖用户、发帖题目、发帖时间、置顶状态等信息，
3. 若想搜索对应帖子的信息，可以在搜索框输入目标帖子的标题或者内容相关的信息，点击搜索帖子，即可显示对应帖子的相关信息。关键词没有必要是完全匹配，可以是部分匹配。
4. 点击`置顶`、`删除帖子`即可完成置顶帖子和删除帖子相关操作。一旦帖子被置顶，则在主页展示的位置会位于未置顶的帖子之前，置顶的帖子会根据时间顺序决定谁在前；删除帖子后，与该帖子相关的回复、文件等信息全部被删除。

想要置顶帖子时，前端将帖子的id等信息传给后端，后端根据这个信息修改数据库中对应的表项。

想要删除帖子时，前端将帖子的id等信息传给后端，后端先在数据库中找到所有关于相关的回复、文件、收藏、喜欢，先将它们删除之后，再将原帖子对应的表项删除。

###### 文件管理

管理步骤：

1. 在管理员首页点击`文件管理`按钮可以进入文件管理界面。
2. 在帖子管理界面可以显示所有帖子的上传用户id、上传用户昵称、文件名等信息
3. 若想搜索对应文件的信息，可以在搜索框输入目标文件的标题相关的信息，点击搜索帖子，即可显示对应文件的相关信息。关键词没有必要是完全匹配，可以是部分匹配。
4. 点击`删除文件`，与该文件相关的表项就会被对应删除。

想要删除文件时，前端将文件的id等信息传给后端，后端根据这个信息删除数据库中对应的表项。